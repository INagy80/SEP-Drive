<div class="main">
  <div class="background-green"></div>

  <div class="main-container d-flex">
    <!-- sidebar -->
    <div class="d-flex flex-column justify-content-between align-items-center p-3 gray-bg">
      <div><i class="fa-solid fa-message"></i></div>
      <div class="d-flex flex-column align-items-center gap-2">
        <i class="fa-solid fa-user cursor-pointer" (click)="profile()"></i>
        <i class="fa-solid fa-door-open cursor-pointer" (click)="logout()"></i>
      </div>
    </div>

    <!-- main area: either chat or placeholder -->
    <div class="d-flex w-100">
      <div class="col-3 overflow-x-scroll">
        <app-chat-list
          [chats]="chats"
          (chatSelected)="chatSelected($event)"
        ></app-chat-list>
      </div>

      <!-- show chat window if a chat is selected -->
      <ng-container *ngIf="selectedChat?.id; else noChatSelected">
        <div class="col-9">
          <div class="d-flex flex-column justify-content-between h-100">
            <!-- header -->
            <div class="gray-bg p-2">
              <div class="d-flex gap-2">
                <div class="user-img">
                  <img src="user.png" alt="" />
                </div>
                <div class="d-flex flex-column">
                  <span>{{ selectedChat.name }}</span>
                  <div class="d-flex gap-1 align-items-center">
                    <small
                      class="online-status"
                      *ngIf="selectedChat.recipientOnline; else offlineTpl"
                    ></small>
                    <small *ngIf="selectedChat.recipientOnline">Online</small>
                    <ng-template #offlineTpl>
                      <small class="offline-status"></small><small>Offline</small>
                    </ng-template>
                  </div>
                </div>
              </div>
            </div>

            <!-- messages scroll area -->
            <div #scrollableDiv class="h-100 bg-chat p-3 overflow-x-scroll">
              <div
                *ngFor="let message of chatMessages; trackBy: trackByMessage"
                [ngClass]="{
                  'message-box self': isSelfMessage(message),
                  'message-box friend': !isSelfMessage(message)
                }"
              >
                <div
                  class="d-flex flex-column"
                  *ngIf="isSelfMessage(message); else friendTpl"
                >
                  <ng-container
                    *ngTemplateOutlet="messageContentTpl; context: { $implicit: message }"
                  ></ng-container>
                </div>
                <ng-template #friendTpl>
                  <div class="d-flex flex-column align-items-end">
                    <ng-container
                      *ngTemplateOutlet="messageContentTpl; context: { $implicit: message }"
                    ></ng-container>
                  </div>
                </ng-template>
              </div>

              <!-- reusable template for text vs media -->
              <ng-template #messageContentTpl let-msg>
                <span *ngIf="msg.type === 'TEXT'">{{ msg.content }}</span>
                <img
                  *ngIf="msg.type !== 'TEXT' && msg.media"
                  width="200"
                  class="cursor-pointer"
                  [src]="'data:image/jpg;base64,' + msg.media"
                  alt=""
                />
                <small class="text-black-50">
                  {{ msg.createdAt | date: 'HH:mm' }}
                  <span *ngIf="msg.state === 'SENT'">
                    <i class="fas fa-check seen"></i>
                  </span>
                  <span *ngIf="msg.state !== 'SENT'">
                    <i class="fas fa-check seen"></i
                    ><i class="fas fa-check seen ml-neg"></i>
                  </span>
                </small>
              </ng-template>
            </div>

            <!-- footer: input area -->
            <div class="gray-bg p-2">
              <div class="d-flex align-items-center gap-2">
                <i
                  class="fas fa-paperclip cursor-pointer"
                  (click)="inputFile.click()"
                ></i>
                <input
                  #inputFile
                  type="file"
                  hidden
                  accept=".jpg,.jpeg,.png,.svg,.mp4,.mov,.mp3"
                  (change)="uploadMedia($event.target)"
                />
                <i
                  class="fa-regular fa-face-smile cursor-pointer"
                  (click)="showEmojis = !showEmojis"
                ></i>
                <emoji-mart
                  *ngIf="showEmojis"
                  [set]="'google'"
                  title="Pick your emoji.."
                  emoji="smile"
                  class="emojis-panel"
                  (emojiClick)="onSelectEmojis($event)"
                ></emoji-mart>
                <input
                  type="text"
                  class="form-control-sm w-100"
                  placeholder="Type a message"
                  [(ngModel)]="messageContent"
                  (keydown)="keyDown($event)"
                  (click)="onClick()"
                />
                <i
                  class="fa-solid"
                  [ngClass]="
                    messageContent ? 'fa-paper-plane' : 'fa-microphone'
                  "
                  (click)="messageContent ? sendMessage() : null"
                ></i>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- placeholder when no chat is selected -->
      <ng-template #noChatSelected>
        <div
          class="d-flex flex-column justify-content-center align-items-center h-100 w-100 bg-chat"
        >
          <img width="300" src="wa_banner.png" alt="" />
          <h2 class="text-black-50">WhatsApp Clone Application By Alibou</h2>
        </div>
      </ng-template>
    </div>
  </div>
</div>
